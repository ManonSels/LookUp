{% extends "layout.html" %}

{% block title %}Manage Sections - {{ topic.title }}{% endblock %}

{% block content %}
<div id="topic-data" data-topic-id="{{ topic.id }}" style="display: none;"></div>

<div class="admin-header">
    <h1>Manage Sections: {{ topic.title }}</h1>
    <div>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        <button id="add-section-btn" class="btn btn-primary">Add Section</button>
    </div>
</div>

<div class="sections-list" id="sections-list">
    {% for section in sections %}
    <div class="section-card" data-section-id="{{ section.id }}">
        <div class="section-header">
            <div class="section-handle">
                <span class="handle-icon">⋮⋮</span>
                <h3>{{ section.title }}</h3>
            </div>
            <div class="section-actions">
                <button class="btn btn-secondary add-item-btn" data-section-id="{{ section.id }}">Add Item</button>
                <button class="btn btn-secondary edit-section-btn" data-section-id="{{ section.id }}">Edit</button>
                <button class="btn btn-danger delete-section-btn" data-section-id="{{ section.id }}">Delete</button>
            </div>
        </div>

        <div class="items-list" id="items-list-{{ section.id }}" data-section-id="{{ section.id }}">
            {% if section.items %}
            {% for item in section.items %}
            <div class="item-card" data-item-id="{{ item.id }}">
                <div class="item-header">
                    <div class="item-handle">
                        <span class="handle-icon">⋮⋮</span>
                        <div class="item-title">
                            <h5>{{ item.title }}</h5>
                        </div>
                    </div>
                    <div class="item-actions">
                        <a href="{{ url_for('admin.edit_item', item_id=item.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                        <a href="{{ url_for('admin.delete_item', item_id=item.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this item?')">Delete</a>
                    </div>
                </div>
                <div class="item-preview">
                    {{ item.markdown_content[:200] }}{% if item.markdown_content|length > 200 %}...{% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-items" data-no-drag>
                <p>No items in this section yet. Drag items here or click "Add Item".</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <h2>No sections yet</h2>
        <p>Add your first section to start building this cheat sheet.</p>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const topicIdElement = document.getElementById('topic-data');
        const topicId = topicIdElement ? topicIdElement.getAttribute('data-topic-id') : null;

        if (!topicId) {
            console.error('Topic ID not found');
            return;
        }

        // -- SECTION DRAG & DROP -- //
        const sectionsList = document.getElementById('sections-list');
        if (sectionsList) {
            const sectionSortable = Sortable.create(sectionsList, {
                handle: '.section-handle .handle-icon',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function(evt) {
                    const sectionIds = Array.from(sectionsList.querySelectorAll('.section-card'))
                        .map(card => card.getAttribute('data-section-id'));
                    
                    fetch("{{ url_for('admin.api_reorder_sections') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            topic_id: parseInt(topicId),
                            order: sectionIds
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert('Error reordering sections: ' + (data.error || 'Unknown error'));
                            // Optionally revert the sort
                            sectionSortable.sort(sectionIds);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error reordering sections. Please check the console.');
                    });
                }
            });
        }

        // -- ITEM DRAG & DROP FOR EACH SECTION -- //
        document.querySelectorAll('[id^="items-list-"]').forEach(itemsList => {
            const sectionId = itemsList.id.replace('items-list-', '');
            
            const itemSortable = Sortable.create(itemsList, {
                group: {
                    name: 'items',
                    pull: true,
                    put: true
                },
                handle: '.item-handle .handle-icon',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                filter: '[data-no-drag]',
                onEnd: function(evt) {
                    const fromSectionId = evt.from.getAttribute('data-section-id');
                    const toSectionId = evt.to.getAttribute('data-section-id');
                    const itemId = evt.item.getAttribute('data-item-id');
                    
                    // If item moved to a different section, update its section_id
                    if (fromSectionId !== toSectionId) {
                        updateItemSection(itemId, toSectionId, fromSectionId);
                    } else {
                        // Same section, just update order
                        updateItemOrderInSection(toSectionId);
                    }
                    
                    // Update empty state visibility for both sections
                    updateEmptyState(fromSectionId);
                    updateEmptyState(toSectionId);
                },
                onAdd: function(evt) {
                    const toSectionId = evt.to.getAttribute('data-section-id');
                    updateEmptyState(toSectionId);
                },
                onRemove: function(evt) {
                    const fromSectionId = evt.from.getAttribute('data-section-id');
                    updateEmptyState(fromSectionId);
                }
            });
            
            // Initialize empty state
            updateEmptyState(sectionId);
        });

        // Function to update empty state visibility
        function updateEmptyState(sectionId) {
            const itemsList = document.getElementById(`items-list-${sectionId}`);
            if (!itemsList) return;
            
            const itemCards = itemsList.querySelectorAll('.item-card');
            const emptyState = itemsList.querySelector('.empty-items');
            
            if (itemCards.length === 0) {
                // Show empty state
                if (emptyState) {
                    emptyState.style.display = 'flex';
                } else {
                    // Create empty state if it doesn't exist
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-items';
                    newEmptyState.setAttribute('data-no-drag', '');
                    newEmptyState.innerHTML = '<p>No items in this section yet. Drag items here or click "Add Item".</p>';
                    itemsList.appendChild(newEmptyState);
                }
            } else {
                // Hide empty state
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
            }
        }

        // Add this new function to handle section changes:
        function updateItemSection(itemId, newSectionId, oldSectionId) {
            fetch("{{ url_for('admin.api_change_item_section') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    item_id: parseInt(itemId),
                    section_id: parseInt(newSectionId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Error moving item: ' + (data.error || 'Unknown error'));
                    // Optionally revert the move
                } else {
                    // Update order in the new section
                    updateItemOrderInSection(newSectionId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error moving item. Please check the console.');
            });
        }

        function updateItemOrderInSection(sectionId) {
            const itemsList = document.getElementById(`items-list-${sectionId}`);
            const itemIds = Array.from(itemsList.querySelectorAll('.item-card'))
                .map(card => card.getAttribute('data-item-id'));
            
            fetch("{{ url_for('admin.api_reorder_items') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    section_id: parseInt(sectionId),
                    order: itemIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Error updating item order:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // -- ADD SECTION -- //
        const addSectionBtn = document.getElementById('add-section-btn');
        if (addSectionBtn) {
            addSectionBtn.addEventListener('click', function () {
                const title = prompt('Enter section title:');
                if (title && title.trim()) {
                    fetch("{{ url_for('admin.api_new_section') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            topic_id: parseInt(topicId),
                            title: title.trim()
                        })
                    })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error creating section: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('Error creating section. Please check the console for details.');
                    });
                }
            });
        }

        // -- ADD ITEM TO SECTION -- //
        var addItemButtons = document.querySelectorAll('.add-item-btn');
        addItemButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                var sectionId = this.getAttribute('data-section-id');
                window.location.href = "{{ url_for('admin.new_item', section_id=0) }}".replace('0', sectionId);
            });
        });

        // -- EDIT SECTION -- //
        var editButtons = document.querySelectorAll('.edit-section-btn');
        editButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                var sectionId = this.getAttribute('data-section-id');
                var sectionCard = this.closest('.section-card');
                var currentTitle = sectionCard.querySelector('h3').textContent;
                var newTitle = prompt('Edit section title:', currentTitle);

                if (newTitle && newTitle.trim() && newTitle !== currentTitle) {
                    fetch("{{ url_for('admin.api_update_section') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            section_id: parseInt(sectionId),
                            title: newTitle.trim(),
                            display_order: 0
                        })
                    })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        if (data.success) {
                            sectionCard.querySelector('h3').textContent = newTitle.trim();
                            alert('Section updated successfully!');
                        } else {
                            alert('Error updating section: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('Error updating section. Please check the console for details.');
                    });
                }
            });
        });

        // -- DELETE SECTION -- //
        var deleteButtons = document.querySelectorAll('.delete-section-btn');
        deleteButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                var sectionId = this.getAttribute('data-section-id');
                var sectionCard = this.closest('.section-card');
                var sectionTitle = sectionCard.querySelector('h3').textContent;

                if (confirm('Are you sure you want to delete the section "' + sectionTitle + '" and all its items? This action cannot be undone.')) {
                    fetch("{{ url_for('admin.api_delete_section') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            section_id: parseInt(sectionId)
                        })
                    })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        if (data.success) {
                            sectionCard.remove();

                            var sectionsList = document.querySelector('.sections-list');
                            var remainingSections = sectionsList.querySelectorAll('.section-card');
                            if (remainingSections.length === 0) {
                                sectionsList.innerHTML = `
                                    <div class="empty-state">
                                        <h2>No sections yet</h2>
                                        <p>Add your first section to start building this cheat sheet.</p>
                                    </div>
                                `;
                            }

                            alert('Section deleted successfully!');
                        } else {
                            alert('Error deleting section: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('Error deleting section. Please check the console for details.');
                    });
                }
            });
        });
    });
</script>
{% endblock %}